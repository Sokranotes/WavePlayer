<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>本地视频波形播放器</title>
<style>
  body { font-family: sans-serif; background: #222; color: #fff; margin: 0; display: flex; }
  #sidebar { width: 250px; background: #333; padding: 10px; box-sizing: border-box; overflow-y: auto; transition: width 0.3s; position: relative; }
  #sidebar.collapsed { width: 0; padding: 0; overflow: hidden; }
  #sidebarToggleIcon { position: fixed; top: 10px; left: 10px; background: #444; color: #fff; border: none; padding: 5px; cursor: pointer; z-index: 1000; }
  #playlist { list-style: none; padding: 0; margin: 10px 0 0 0; }
  #playlist li { padding: 5px; cursor: pointer; border-bottom: 1px solid #555; display: flex; align-items: center; justify-content: space-between; }
  #playlist li:hover { background: #555; }
  .delete-btn { background: red; color: white; border: none; cursor: pointer; padding: 2px 5px; }
  #mainContent { flex: 1; text-align: center; }
  #playerWrap { width: 80%; max-width: 1200px; margin: 20px auto; }
  #video { width: 100%; height: auto; max-height: 80vh; display: block; }
  #waveformCanvas { width: 100%; height: 100px; background: #111; display: block; cursor: pointer; }
  #infoRow { display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 10px; }
  #dropZone { border: 2px dashed #555; padding: 40px 20px; margin: 10px auto; max-width: 80%; font-size: 1.2em; height: 160px; display: flex; align-items: center; justify-content: center; flex-direction: column; }
  #sortControls { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px; }
  button { padding: 10px 20px; font-size: 1em; cursor: pointer; }
</style>
</head>
<body>
<button id="sidebarToggleIcon">≡</button>
<div id="sidebar" class="collapsed">
  <div id="sortControls">
    <button id="sortAsc">⬆</button>
    <button id="sortDesc">⬇</button>
    <button id="sortRandom">🔀</button>
    <button id="deleteSelected">🗑</button>
  </div>
  <ul id="playlist"></ul>
</div>
<div id="mainContent">
  <div id="playerWrap">
    <video id="video" controls></video>
    <canvas id="waveformCanvas"></canvas>
  </div>
  <div id="infoRow">
    <div id="status">等待加载波形...</div>
    <button id="fullscreenBtn">网页全屏</button>
  </div>
  <h1 id="title">本地视频波形播放器</h1>
  <div id="dropZone">将视频文件拖到这里，或点击选择<input type="file" id="fileInput" accept="video/*" multiple></div>
</div>
<script>
const sidebar = document.getElementById('sidebar');
const sidebarToggleIcon = document.getElementById('sidebarToggleIcon');
const playlistEl = document.getElementById('playlist');
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const playerWrap = document.getElementById('playerWrap');
const video = document.getElementById('video');
const canvas = document.getElementById('waveformCanvas');
const ctx = canvas.getContext('2d');
const statusText = document.getElementById('status');
const fullscreenBtn = document.getElementById('fullscreenBtn');
const sortAscBtn = document.getElementById('sortAsc');
const sortDescBtn = document.getElementById('sortDesc');
const sortRandomBtn = document.getElementById('sortRandom');
const deleteSelectedBtn = document.getElementById('deleteSelected');
let audioContext;
let waveformData = [];
let peaks = [];
let playlist = JSON.parse(localStorage.getItem('playlist') || '[]').map(f => new File([], f.name));

sidebarToggleIcon.addEventListener('click', () => {
  sidebar.classList.toggle('collapsed');
});

function savePlaylist() {
  localStorage.setItem('playlist', JSON.stringify(playlist.map(f => ({ name: f.name }))));
}

function addToPlaylist(file) {
  playlist.push(file);
  savePlaylist();
  renderPlaylist();
}

function renderPlaylist() {
  playlistEl.innerHTML = '';
  playlist.forEach((file, index) => {
    const li = document.createElement('li');
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.dataset.index = index;
    li.appendChild(checkbox);

    const span = document.createElement('span');
    span.textContent = file.name;
    span.style.flex = '1';
    span.addEventListener('click', () => handleFile(file));
    li.appendChild(span);

    const delBtn = document.createElement('button');
    delBtn.textContent = '❌';
    delBtn.className = 'delete-btn';
    delBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      if (confirm(`确定删除 ${file.name} 吗？`)) {
        playlist.splice(index, 1);
        savePlaylist();
        renderPlaylist();
      }
    });
    li.appendChild(delBtn);

    playlistEl.appendChild(li);
  });
}

deleteSelectedBtn.addEventListener('click', () => {
  const selected = [...playlistEl.querySelectorAll('input[type="checkbox"]:checked')].map(cb => parseInt(cb.dataset.index));
  if (selected.length > 0 && confirm('确定删除选中的文件吗？')) {
    playlist = playlist.filter((_, idx) => !selected.includes(idx));
    savePlaylist();
    renderPlaylist();
  }
});

sortAscBtn.addEventListener('click', () => {
  playlist.sort((a,b) => a.name.localeCompare(b.name));
  savePlaylist();
  renderPlaylist();
});

sortDescBtn.addEventListener('click', () => {
  playlist.sort((a,b) => b.name.localeCompare(a.name));
  savePlaylist();
  renderPlaylist();
});

sortRandomBtn.addEventListener('click', () => {
  playlist.sort(() => Math.random() - 0.5);
  savePlaylist();
  renderPlaylist();
});

async function generateWaveform(file) {
  statusText.textContent = '正在解码音频以生成波形...';
  audioContext = new (window.AudioContext || window.webkitAudioContext)();
  const arrayBuffer = await file.arrayBuffer();
  const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
  const rawData = audioBuffer.getChannelData(0);
  const samples = 1000;
  const blockSize = Math.floor(rawData.length / samples) || 1;
  waveformData = [];
  let noiseFloor = 0;
  for (let i = 0; i < samples; i++) {
    let sum = 0;
    for (let j = 0; j < blockSize; j++) {
      const idx = i * blockSize + j;
      if (idx < rawData.length) sum += Math.abs(rawData[idx]);
    }
    waveformData.push(sum / blockSize);
  }
  const sorted = [...waveformData].sort((a,b) => a-b);
  const noiseSampleCount = Math.floor(samples * 0.1);
  noiseFloor = sorted.slice(0, noiseSampleCount).reduce((a,b) => a+b, 0) / noiseSampleCount;
  waveformData = waveformData.map(v => Math.max(0, v - noiseFloor));
  let maxVal = Math.max(...waveformData) || 1;
  waveformData = waveformData.map(v => v / maxVal);
  const threshold = 0.7;
  peaks = waveformData.map(v => v > threshold);
  resizeCanvasToPlayer();
  drawWaveform(0);
  statusText.textContent = '波形加载完成';
}

function resizeCanvasToPlayer() {
  const w = Math.max(1, Math.floor(playerWrap.clientWidth));
  canvas.width = w;
  canvas.height = 100;
}

function drawWaveform(progress = 0) {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.lineWidth = 0.5;
  const middle = canvas.height / 2;
  for (let i = 0; i < waveformData.length; i++) {
    const x = Math.round((i / waveformData.length) * canvas.width) + 0.5;
    const y = waveformData[i] * (canvas.height / 2);
    ctx.strokeStyle = peaks[i] ? '#ff0' : '#0f0';
    ctx.beginPath();
    ctx.moveTo(x, middle - y);
    ctx.lineTo(x, middle + y);
    ctx.stroke();
  }
  ctx.fillStyle = 'rgba(255,0,0,0.8)';
  ctx.fillRect(Math.round(progress * canvas.width), 0, 1, canvas.height);
}

video.addEventListener('timeupdate', () => {
  if (video.duration) drawWaveform(video.currentTime / video.duration);
});

window.addEventListener('resize', () => {
  resizeCanvasToPlayer();
  drawWaveform(video.duration ? video.currentTime / video.duration : 0);
});

canvas.addEventListener('click', e => {
  if (!video.duration) return;
  const rect = canvas.getBoundingClientRect();
  const percent = (e.clientX - rect.left) / canvas.width;
  video.currentTime = percent * video.duration;
});

function handleFile(file) {
  const url = URL.createObjectURL(file);
  video.src = url;
  waveformData = [];
  peaks = [];
  video.addEventListener('loadedmetadata', () => {
    resizeCanvasToPlayer();
  }, { once: true });
  generateWaveform(file);
}

dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.style.borderColor = '#0f0'; });
dropZone.addEventListener('dragleave', e => { e.preventDefault(); dropZone.style.borderColor = '#555'; });
dropZone.addEventListener('drop', e => {
  e.preventDefault(); dropZone.style.borderColor = '#555';
  for (const file of e.dataTransfer.files) {
    addToPlaylist(file);
  }
  handleFile(e.dataTransfer.files[0]);
});

fileInput.addEventListener('change', e => {
  for (const file of e.target.files) {
    addToPlaylist(file);
  }
  handleFile(e.target.files[0]);
});

fullscreenBtn.addEventListener('click', () => {
  if (playerWrap.requestFullscreen) {
    playerWrap.requestFullscreen();
  } else if (playerWrap.webkitRequestFullscreen) {
    playerWrap.webkitRequestFullscreen();
  } else if (playerWrap.msRequestFullscreen) {
    playerWrap.msRequestFullscreen();
  }
});

renderPlaylist();
</script>
</body>
</html>
